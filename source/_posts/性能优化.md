---
title: 性能优化
tags: []
top: false
comments: true
date: 2020-05-15 13:17:21
permalink:
categories:
description:
image:
keywords:
---


### 查看服务器连接等待情况

`netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'`

```
ESTABLISHED 1 # 正在链接数量
TIME_WAIT 22  # 等待链接数量
```

### 查看服务器句柄数

句柄数越大支持的连接数越多，最大好像是65536

```
ulimit -n

ulimit -a
```

### nginx链接优化
https://www.jianshu.com/p/a1aa93b55f7a

大概意思是 使用长连接，增大最大连接数

### linux内核优化

#### 防火墙相关参数

```
net.netfilter.nf_conntrack_max = 6553500
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_established = 3600
```
> 如果出现`没有那个文件或目录`错误，先`lsmod |grep conntrack`查询是否加载ip_conntrack，使用`modprobe ip_conntrack`加载


### 使用arthas进行性能监控

<!-- more -->

```
track [classname] [method] ['#cost > 150']
```
> `track`跟踪方法时间，classname类全路径 method方法名，'#cost > 150'可选时间过滤条件，跟踪方法调用栈并显示执行时间

<hr />